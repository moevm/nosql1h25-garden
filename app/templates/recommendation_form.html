{% extends "activity_layout.html" %}

{% block title %}Новая рекомендация | Активности - Огородник{% endblock %}

{% block activity_content %}
<h3>Создать новую рекомендацию вручную</h3>

<form method="POST" action="{{ url_for('recommendation_bp.new_recommendation') }}" class="mt-3 p-3 border rounded bg-light">
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="garden_id">Участок <span class="text-danger">*</span></label>
            <select name="garden_id" id="garden_id" class="form-control" required>
                <option value="">-- Выберите участок --</option>
                {% for garden in user_gardens %}
                    <option value="{{ garden._id }}"
                            {% if form_data.garden_id == garden._id|string %}selected{% endif %}
                            {% if not form_data.garden_id and initial_beds and loop.first %}selected{% endif %}>
                        {{ garden.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-6">
            <label for="bed_id">Грядка <span class="text-danger">*</span></label>
            <select name="bed_id" id="bed_id" class="form-control" required>
                <option value="">-- Сначала выберите участок --</option>
                {% for bed in initial_beds %}
                     <option value="{{ bed.id }}" {% if form_data.bed_id == bed.id|string %}selected{% endif %}>{{ bed.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="action_type">Тип действия <span class="text-danger">*</span></label>
        <select name="action_type" id="action_type" class="form-control" required>
            <option value="">-- Выберите тип --</option>
            {% for type in RECOMMENDATION_ACTION_TYPES %}
                {% if type %}<option value="{{ type }}" {% if form_data.action_type == type %}selected{% endif %}>{{ type }}</option>{% endif %}
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="description">Описание рекомендации</label>
        <textarea name="description" id="description" class="form-control" rows="3">{{ form_data.description if form_data.description }}</textarea>
    </div>

    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="due_date">Дата выполнения <span class="text-danger">*</span></label>
            <input type="date" name="due_date" id="due_date" value="{{ form_data.due_date if form_data.due_date else today_date }}" class="form-control" required>
        </div>
        <div class="form-group col-md-6">
            <label for="due_time">Время выполнения <span class="text-danger">*</span></label>
            <input type="time" name="due_time" id="due_time" value="{{ form_data.due_time if form_data.due_time else current_time }}" class="form-control" required>
        </div>
    </div>

    <div class="form-group mt-4">
        <button type="submit" class="btn btn-primary">Создать рекомендацию</button>
        <a href="{{ url_for('recommendation_bp.list_recommendations') }}" class="btn btn-secondary">Отмена</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gardenSelect = document.getElementById('garden_id');
    const bedSelect = document.getElementById('bed_id');
    // Use form_data.bed_id if available (e.g. on validation error re-render)
    const initialBedId = "{{ form_data.bed_id if form_data.bed_id else '' }}";

    function populateBeds(gardenId, selectedBedId) {
        while (bedSelect.options.length > 1) {
            bedSelect.remove(1);
        }
        bedSelect.options[0].text = "-- Сначала выберите участок --";
        bedSelect.disabled = true;

        if (gardenId) {
            bedSelect.disabled = false;
            bedSelect.options[0].text = "-- Загрузка грядок... --";
            // Note: Using care_bp.beds_for_dropdown as it's already available and suitable
            fetch(`{{ url_for('care_bp.beds_for_dropdown', garden_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', gardenId))
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    bedSelect.options[0].text = "-- Выберите грядку --";
                    if (data.error) {
                        console.error('Error fetching beds:', data.error);
                        bedSelect.options[0].text = "-- Ошибка загрузки грядок --";
                        return;
                    }
                    if (data.length === 0) {
                        bedSelect.options[0].text = "-- Нет грядок на этом участке --";
                        return;
                    }
                    data.forEach(bed => {
                        const option = new Option(bed.name, bed.id);
                        if (bed.id === selectedBedId) {
                            option.selected = true;
                        }
                        bedSelect.add(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching beds:', error);
                    bedSelect.options[0].text = "-- Ошибка загрузки грядок --";
                });
        }
    }

    gardenSelect.addEventListener('change', function() {
        populateBeds(this.value, null); 
    });

    if (gardenSelect.value) {
        populateBeds(gardenSelect.value, initialBedId);
    } else {
        bedSelect.disabled = true;
    }
});
</script>
{% endblock %} 