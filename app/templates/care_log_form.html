{% extends "activity_layout.html" %}

{% block title %}{% if is_edit %}Редактировать запись{% else %}Новая запись{% endif %} в журнале ухода | Уход за грядками {% endblock %}

{% block activity_content %}
<h3>{% if is_edit %}Редактировать запись в журнале ухода{% else %}Добавить новую запись в журнал ухода{% endif %}</h3>

<form method="POST" action="{{ url_for('care_bp.new_care_log') }}" class="mt-3 p-3 border rounded bg-light">
    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="garden_id">Участок <span class="text-danger">*</span></label>
            <select name="garden_id" id="garden_id" class="form-control" required>
                <option value="">-- Выберите участок --</option>
                {% for garden in user_gardens %}
                    <option value="{{ garden._id }}" 
                            {% if form_data and form_data.garden_id == str(garden._id) %}selected{% endif %}
                            {% if not form_data and initial_beds and loop.first %}selected{% endif %}>
                        {{ garden.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-6">
            <label for="bed_id">Грядка <span class="text-danger">*</span></label>
            <select name="bed_id" id="bed_id" class="form-control" required>
                <option value="">-- Сначала выберите участок --</option>
                {% for bed in initial_beds %}
                     <option value="{{ bed.id }}" {% if form_data and form_data.bed_id == bed.id %}selected{% endif %}>{{ bed.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group col-md-4">
            <label for="action_type">Тип действия <span class="text-danger">*</span></label>
            <select name="action_type" id="action_type" class="form-control" required>
                <option value="">-- Выберите тип --</option>
                {% for type in CARE_ACTION_TYPES %}
                    {% if type %}<option value="{{ type }}" {% if form_data and form_data.action_type == type %}selected{% endif %}>{{ type }}</option>{% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-4">
            <label for="log_date">Дата <span class="text-danger">*</span></label>
            <input type="date" name="log_date" id="log_date" value="{{ form_data.log_date if form_data and form_data.log_date else today_date }}" class="form-control" required>
        </div>
        <div class="form-group col-md-4">
            <label for="log_time">Время <span class="text-danger">*</span></label>
            <input type="time" name="log_time" id="log_time" value="{{ form_data.log_time if form_data and form_data.log_time else current_time }}" class="form-control" required>
        </div>
    </div>

    <div class="form-group">
        <label for="notes">Заметки</label>
        <textarea name="notes" id="notes" class="form-control" rows="3">{{ form_data.notes if form_data and form_data.notes }}</textarea>
    </div>

    <div class="form-group mt-4">
        <button type="submit" class="btn btn-primary">{% if is_edit %}Сохранить изменения{% else %}Добавить запись{% endif %}</button>
        <a href="{{ url_for('care_bp.list_care_logs') }}" class="btn btn-secondary">Отмена</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gardenSelect = document.getElementById('garden_id');
    const bedSelect = document.getElementById('bed_id');
    const initialBedId = "{{ form_data.bed_id if form_data and form_data.bed_id else '' }}";

    function populateBeds(gardenId, selectedBedId) {
        // Clear current bed options (except the default one)
        while (bedSelect.options.length > 1) {
            bedSelect.remove(1);
        }
        if (!gardenId) {
            bedSelect.options[0].text = "-- Сначала выберите участок --";
            bedSelect.disabled = true;
            return;
        }

        bedSelect.disabled = false;
        bedSelect.options[0].text = "-- Загрузка грядок... --";

        fetch(`{{ url_for('care_bp.beds_for_dropdown', garden_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', gardenId))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                bedSelect.options[0].text = "-- Выберите грядку --";
                if (data.error) {
                    console.error('Error fetching beds:', data.error);
                     bedSelect.options[0].text = "-- Ошибка загрузки грядок --";
                    return;
                }
                if (data.length === 0) {
                    bedSelect.options[0].text = "-- Нет грядок на этом участке --";
                    return;
                }
                data.forEach(bed => {
                    const option = new Option(bed.name, bed.id);
                    if (bed.id === selectedBedId) {
                        option.selected = true;
                    }
                    bedSelect.add(option);
                });
            })
            .catch(error => {
                console.error('Error fetching beds:', error);
                bedSelect.options[0].text = "-- Ошибка загрузки грядок --";
            });
    }

    gardenSelect.addEventListener('change', function() {
        populateBeds(this.value, null); // No specific bed to pre-select on change by user
    });

    // Initial population if a garden is already selected (form re-render after error, or if editing)
    if (gardenSelect.value) {
        populateBeds(gardenSelect.value, initialBedId);
    } else {
        bedSelect.disabled = true; // Disable bed select if no garden is initially chosen
    }
});
</script>
{% endblock %} 