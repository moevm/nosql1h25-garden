{% extends "activity_layout.html" %}

{% block title %}Журнал ухода | Активности - Огородник{% endblock %}

{% block activity_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="fas fa-book-medical"></i> Журнал ухода ({{ total_logs if total_logs is defined else 0 }})</h3>
    <a href="{{ url_for('care_bp.new_care_log') }}" class="btn btn-success"><i class="fas fa-plus"></i> Добавить запись</a>
</div>

<!-- Filters and Sorting -->
<form method="GET" action="{{ url_for('care_bp.list_care_logs') }}" class="filter-sort-form mb-3 p-3 border rounded bg-light">
    <div class="form-row">
        <div class="form-group col-md-3">
            <label for="filter_garden_id">Участок</label> {# Renamed id to avoid conflict with recommendation page #}
            <select name="garden_id" id="filter_garden_id" class="form-control form-control-sm" onchange="this.form.submit()">
                <option value="">Все участки</option>
                {% for garden in user_gardens %}
                    <option value="{{ garden._id }}" {% if filters and filters.garden_id == garden._id|string %}selected{% endif %}>{{ garden.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="filter_bed_id">Грядка</label> {# Renamed id #}
            <select name="bed_id" id="filter_bed_id" class="form-control form-control-sm">
                <option value="">Все грядки</option>
                {% for bed in user_beds %}
                <option value="{{ bed._id }}" {% if filters and filters.bed_id == bed._id|string %}selected{% endif %}>{{ bed.name }}</option>

                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="filter_action_type">Тип действия</label> {# Renamed id #}
            <select name="action_type" id="filter_action_type" class="form-control form-control-sm">
                <option value="">Все типы</option>
                {% for type in CARE_ACTION_TYPES %}
                    {% if type %}<option value="{{ type }}" {% if filters and filters.action_type == type %}selected{% endif %}>{{ type }}</option>{% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group col-md-3">
            <label for="filter_date_from">Дата от</label> {# Renamed id #}
            <input type="date" name="date_from" id="filter_date_from" value="{{ filters.date_from if filters else '' }}" class="form-control form-control-sm">
        </div>
        <div class="form-group col-md-3">
            <label for="filter_date_to">Дата до</label> {# Renamed id #}
            <input type="date" name="date_to" id="filter_date_to" value="{{ filters.date_to if filters else '' }}" class="form-control form-control-sm">
        </div>
        <div class="form-group col-md-2">
            <label for="filter_sort_by">Сортировать по</label> {# Renamed id #}
            <select name="sort_by" id="filter_sort_by" class="form-control form-control-sm">
                <option value="log_date" {% if filters and filters.sort_by == 'log_date' %}selected{% endif %}>Дате записи</option>
                <option value="garden_name" {% if filters and filters.sort_by == 'garden_name' %}selected{% endif %}>Участку</option>
                <option value="bed_name" {% if filters and filters.sort_by == 'bed_name' %}selected{% endif %}>Грядке</option>
            </select>
        </div>
        <div class="form-group col-md-2">
            <label for="filter_sort_order">Порядок</label> {# Renamed id #}
            <select name="sort_order" id="filter_sort_order" class="form-control form-control-sm">
                <option value="desc" {% if filters and filters.sort_order == 'desc' %}selected{% endif %}>Убывание</option>
                <option value="asc" {% if filters and filters.sort_order == 'asc' %}selected{% endif %}>Возрастание</option>
            </select>
        </div>
        <div class="form-group col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-sm btn-block">Применить</button>
        </div>
    </div>
</form>


{% if care_logs %}
    <div class="list-group">
        {% for log in care_logs %}
            <div class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ log.action_type }} - {{ log.bed_name }} ({{ log.garden_name }})</h5>
                    <small>{{ log.log_date.strftime('%Y-%m-%d %H:%M') if log.log_date else 'N/A' }}</small>
                </div>
                <p class="mb-1">{{ log.notes if log.notes else 'Без заметок.' }}</p>
                <small class="text-muted">
                    Создано: {{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else 'N/A' }}
                    {% if log.linked_recommendation_id %}
                        <span class="badge badge-info ml-2">Связано с рек.</span>
                    {% endif %}
                </small>
                 {# Add Edit/Delete for care_logs later if needed #}
            </div>
        {% endfor %}
    </div>

    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
            {% if current_page > 1 %}
                <li class="page-item"><a class="page-link" href="{{ url_for('care_bp.list_care_logs', page=current_page-1, **request.args) }}">«</a></li>
            {% endif %}
            {% for page_num in range(1, total_pages + 1) %}
                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('care_bp.list_care_logs', page=page_num, **request.args) }}">{{ page_num }}</a>
                </li>
            {% endfor %}
            {% if current_page < total_pages %}
                <li class="page-item"><a class="page-link" href="{{ url_for('care_bp.list_care_logs', page=current_page+1, **request.args) }}">»</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
{% else %}
    <div class="alert alert-info" role="alert">
        Записей в журнале ухода пока нет. <a href="{{ url_for('care_bp.new_care_log') }}" class="alert-link">Добавить первую запись?</a>
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gardenFilterSelect = document.getElementById('filter_garden_id');
    const bedFilterSelect = document.getElementById('filter_bed_id');
    
    if (gardenFilterSelect && bedFilterSelect) {
        const initialBedOptions = Array.from(bedFilterSelect.options);
        bedFilterSelect.dataset.selectedValue = "{{ filters.bed_id if filters and filters.bed_id else '' }}";

        gardenFilterSelect.addEventListener('change', function() {
            const gardenId = this.value;
            while (bedFilterSelect.options.length > 1) {
                bedFilterSelect.remove(1);
            }
            bedFilterSelect.dataset.selectedValue = ""; // Reset selected bed when garden changes

            if (gardenId) {
                fetch(`{{ url_for('care_bp.beds_for_dropdown', garden_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', gardenId))
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error fetching beds:', data.error);
                            return;
                        }
                        data.forEach(bed => {
                            const option = new Option(bed.name, bed.id);
                            bedFilterSelect.add(option);
                        });
                    })
                    .catch(error => console.error('Error fetching beds:', error));
            } 
        });
         // If a garden is pre-selected (e.g. from query params), populate its beds
        if (gardenFilterSelect.value && bedFilterSelect.dataset.selectedValue) {
             fetch(`{{ url_for('care_bp.beds_for_dropdown', garden_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', gardenFilterSelect.value))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching beds:', data.error);
                        return;
                    }
                    while (bedFilterSelect.options.length > 1) { bedFilterSelect.remove(1); }
                    data.forEach(bed => {
                        const option = new Option(bed.name, bed.id);
                        if (bed.id === bedFilterSelect.dataset.selectedValue) {
                            option.selected = true;
                        }
                        bedFilterSelect.add(option);
                    });
                }).catch(error => console.error('Error fetching beds:', error));
        }
    }
});
</script>

{% endblock %} 